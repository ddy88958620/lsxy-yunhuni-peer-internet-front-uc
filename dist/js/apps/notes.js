$(function(){var e=Backbone.Model.extend({defaults:function(){return{id:i.nextId(),name:"New note",description:"",date:Date.now()}}}),t=Backbone.Collection.extend({model:e,localStorage:new Backbone.LocalStorage("notes-app"),nextId:function(){return this.url?null:this.length?this.last().get("id")+1:1},comparator:function(e){return parseInt(e.get("id"))},search:function(e){var t=new RegExp(e,"gi");return _(this.filter(function(e){e.trigger("show"),0==t.test(e.get("description"))&&e.trigger("hide")}))}}),i=new t,n=Backbone.View.extend({tagName:"li",className:"list-group-item hover",template:_.template($("#item-template").html()),events:{"click .destroy":"clear",click:"select"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"select",this.select),this.listenTo(this.model,"active",this.active),this.listenTo(this.model,"hide",this.hide),this.listenTo(this.model,"show",this.show)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},clear:function(e){this.model.destroy(),window.history.back()},select:function(){this.active(),a.navigate("notes/"+this.model.get("id"),{trigger:!0})},active:function(){this.$el.parent().find(".active").removeClass("active"),this.$el.addClass("active")},hide:function(){this.$el.addClass("hide")},show:function(){this.$el.removeClass("hide")}}),s=Backbone.View.extend({el:$("#note-list"),events:{"click #new-note":"create","keyup #search-note":"search"},initialize:function(){this.listenTo(i,"add",this.addOne),this.listenTo(i,"reset",this.addAll),this.listenTo(i,"all",this.render)},render:function(){},addOne:function(e){var t=new n({model:e});this.$el.find("#note-items").prepend(t.render().el)},addAll:function(){i.each(this.addOne,this)},create:function(t){var n=new e;i.create(n,{success:function(){n.trigger("select")}})},search:function(){i.search($("#search-note").val())}}),o=Backbone.View.extend({el:$("#note-detail"),template:_.template($("#note-template").html()),events:{"keyup textarea":"updateOnKeyup"},initialize:function(){this.$el.html(this.template(this.model.toJSON()))},updateOnKeyup:function(e){var t="",i=$(e.target).val(),n=i.split(/\r\n|\r|\n/g);n.length&&(t=_.first(_.filter(n,function(e){return!!$.trim(e)}))),this.model.save({name:t,description:i})},close:function(){this.$el.unbind(),this.$el.empty()}}),l=Backbone.Router.extend({routes:{"":"list","notes/:id":"details"},initialize:function(){},list:function(){if(!this.noteListView){this.noteListView=new s;var e=this;i.fetch({success:function(){var t=a.requiredId||i.length&&i.at(i.length-1).get("id");i.length&&e.details(t)&&a.navigate("notes/"+t),!i.length&&$("#new-note").trigger("click")}})}},details:function(e){return a.requiredId=e,this.list(),this.noteView&&this.noteView.close(),this.note=i.get(e),this.note&&(this.note.trigger("active"),this.noteView=new o({model:this.note})),this}}),a=new l;Backbone.history.start()});